# .github/workflows/deploy-docs.yml
name: Deploy Docusaurus Documentation

permissions:
  contents: read
  pages: write
  id-token: write

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'docs/**'
      - 'src/**'
      - 'static/**'
      - 'docusaurus.config.js'
      - 'package.json'
      - 'package-lock.json'
      - 'yarn.lock'
      - '.github/workflows/deploy-docs.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'docs/**'
      - 'src/**'
      - 'static/**'
      - 'docusaurus.config.js'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'github-pages'
        type: choice
        options:
          - github-pages
          - netlify
          - vercel
          - custom
      build_type:
        description: 'Build type'
        required: false
        default: 'production'
        type: choice
        options:
          - production
          - development
          - preview
      clear_cache:
        description: 'Clear build cache'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  DEPLOYMENT_BRANCH: gh-pages

# GitHub Pages ë°°í¬ë¥¼ ìœ„í•œ ë™ì‹œì„± ì œì–´
concurrency:
  group: pages-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ğŸ—ï¸ Build Job
  build:
    name: Build Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 15

    outputs:
      deployment-url: ${{ steps.deployment.outputs.page_url }}
      cache-hit: ${{ steps.cache.outputs.cache-hit }}

    outputs:
      page_url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ (git-based last modified ì§€ì›)

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'  # ë˜ëŠ” 'yarn'

    - name: ğŸ”§ Setup Pages (GitHub Pages ë°°í¬ì‹œ)
      uses: actions/configure-pages@v4

    - name: ğŸ’¾ Cache dependencies
      id: cache
      uses: actions/cache@v3
      with:
        path: |
          node_modules
          .docusaurus
          ~/.npm
        key: ${{ runner.os }}-docusaurus-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-docusaurus-

    - name: ğŸ§¹ Clear cache (if requested)
      if: github.event.inputs.clear_cache == 'true'
      run: |
        echo "ğŸ§¹ Clearing build cache..."
        rm -rf node_modules .docusaurus build
        npm cache clean --force

    - name: ğŸ“¥ Install dependencies
      run: |
        echo "ğŸ“¥ Installing dependencies..."
        npm ci --prefer-offline --no-audit

    - name: ğŸ” Verify Docusaurus config
      run: |
        echo "ğŸ” Verifying Docusaurus configuration..."
        if [[ ! -f "docusaurus.config.js" ]]; then
          echo "âŒ docusaurus.config.js not found!"
          exit 1
        fi
        
        echo "âœ… Configuration file found"
        
        # ì„¤ì • íŒŒì¼ ê²€ì¦
        node -e "
        try {
          const config = require('./docusaurus.config.js');
          console.log('âœ… Configuration valid');
          console.log('ğŸ“„ Site title:', config.title);
          console.log('ğŸŒ Base URL:', config.baseUrl);
          console.log('ğŸ”— URL:', config.url);
        } catch (error) {
          console.error('âŒ Configuration error:', error.message);
          process.exit(1);
        }
        "

    - name: ğŸ—ï¸ Build documentation
      env:
        NODE_ENV: ${{ github.event.inputs.build_type || 'production' }}
        CI: true
      run: |
        echo "ğŸ—ï¸ Building Docusaurus documentation..."
        echo "Environment: $NODE_ENV"
        echo "Build type: ${{ github.event.inputs.build_type || 'production' }}"
        
        # ë¹Œë“œ ì‹œì‘ ì‹œê°„ ê¸°ë¡
        start_time=$(date +%s)
        
        # Docusaurus ë¹Œë“œ ì‹¤í–‰
        npm run build -- --out-dir build
        
        # ë¹Œë“œ ì™„ë£Œ ì‹œê°„ ê³„ì‚°
        end_time=$(date +%s)
        build_duration=$((end_time - start_time))
        
        echo "âœ… Build completed in ${build_duration} seconds"
        
        # ë¹Œë“œ ê²°ê³¼ ê²€ì¦
        if [[ ! -d "build" ]]; then
          echo "âŒ Build directory not found!"
          exit 1
        fi
        
        # ë¹Œë“œ í†µê³„
        echo "ğŸ“Š Build Statistics:"
        echo "  ğŸ“ Total files: $(find build -type f | wc -l)"
        echo "  ğŸ“ Total size: $(du -sh build | cut -f1)"
        echo "  ğŸ—‚ï¸ HTML files: $(find build -name "*.html" | wc -l)"
        echo "  ğŸ¨ CSS files: $(find build -name "*.css" | wc -l)"
        echo "  ğŸ“œ JS files: $(find build -name "*.js" | wc -l)"

    - name: ğŸ§ª Test built site
      run: |
        echo "ğŸ§ª Testing built documentation..."
        
        # í•„ìˆ˜ íŒŒì¼ ê²€ì¦
        required_files=(
          "build/index.html"
          "build/404.html"
        )
        
        for file in "${required_files[@]}"; do
          if [[ -f "$file" ]]; then
            echo "âœ… Found: $file"
          else
            echo "âŒ Missing: $file"
            exit 1
          fi
        done
        
        # HTML íŒŒì¼ ìœ íš¨ì„± ê²€ì‚¬ (ê¸°ë³¸ì ì¸)
        html_files=$(find build -name "*.html" | head -5)
        for html_file in $html_files; do
          if grep -q "</html>" "$html_file"; then
            echo "âœ… Valid HTML: $(basename $html_file)"
          else
            echo "âš ï¸  Potentially invalid HTML: $(basename $html_file)"
          fi
        done

    - name: ğŸ“¤ Upload GitHub Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: build

    - name: ğŸ“¤ Upload build artifacts (for other deployments)
      if: github.event.inputs.environment != 'github-pages' && github.event_name != 'push'
      uses: actions/upload-artifact@v4
      with:
        name: docusaurus-build-${{ github.sha }}
        path: build/
        retention-days: 30

    - name: ğŸ“‹ Generate build summary
      run: |
        echo "## ğŸ“š Documentation Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "**Build Time:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**Node.js Version:** ${{ env.NODE_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** ${{ github.event.inputs.build_type || 'production' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Cache Hit:** ${{ steps.cache.outputs.cache-hit }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š Build Statistics" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Total Files | $(find build -type f | wc -l) |" >> $GITHUB_STEP_SUMMARY
        echo "| Total Size | $(du -sh build | cut -f1) |" >> $GITHUB_STEP_SUMMARY
        echo "| HTML Files | $(find build -name "*.html" | wc -l) |" >> $GITHUB_STEP_SUMMARY
        echo "| CSS Files | $(find build -name "*.css" | wc -l) |" >> $GITHUB_STEP_SUMMARY
        echo "| JS Files | $(find build -name "*.js" | wc -l) |" >> $GITHUB_STEP_SUMMARY

  # ğŸš€ GitHub Pages Deployment
  deploy-github-pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build
    if: |
      (github.event.inputs.environment == 'github-pages' || 
       (github.event.inputs.environment == '' && github.event_name == 'push')) &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    timeout-minutes: 10

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - name: ğŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: ğŸ“ Create deployment summary
      run: |
        echo "## ğŸš€ GitHub Pages Deployment" >> $GITHUB_STEP_SUMMARY
        echo "**Deployment URL:** ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
        echo "**Deployment Time:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** âœ… Successful" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ‰ **Documentation is now live!**" >> $GITHUB_STEP_SUMMARY

  # ğŸŒ Netlify Deployment (ì„ íƒì )
  deploy-netlify:
    name: Deploy to Netlify
    runs-on: ubuntu-latest
    needs: build
    if: github.event.inputs.environment == 'netlify'
    timeout-minutes: 10

    steps:
    - name: ğŸ“¥ Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: docusaurus-build-${{ github.sha }}
        path: build

    - name: ğŸš€ Deploy to Netlify
      uses: nwtgck/actions-netlify@v3.0
      with:
        publish-dir: './build'
        production-branch: main
        github-token: ${{ secrets.GITHUB_TOKEN }}
        deploy-message: |
          Deploy from GitHub Actions
          Commit: ${{ github.sha }}
          Branch: ${{ github.ref_name }}
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

  # â–² Vercel Deployment (ì„ íƒì )
  deploy-vercel:
    name: Deploy to Vercel
    runs-on: ubuntu-latest
    needs: build
    if: github.event.inputs.environment == 'vercel'
    timeout-minutes: 10

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ“¥ Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: docusaurus-build-${{ github.sha }}
        path: build

    - name: ğŸš€ Deploy to Vercel
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        working-directory: ./build

  # ğŸ§ª PR Preview (Pull Requestìš©)
  pr-preview:
    name: PR Preview Build
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    timeout-minutes: 15

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¥ Install dependencies
      run: npm ci --prefer-offline --no-audit

    - name: ğŸ—ï¸ Build for preview
      env:
        NODE_ENV: development
      run: |
        echo "ğŸ—ï¸ Building PR preview..."
        npm run build

    - name: ğŸ“ Comment on PR
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // ë¹Œë“œ í†µê³„ ìˆ˜ì§‘
          const buildDir = 'build';
          const files = fs.readdirSync(buildDir, { recursive: true });
          const htmlFiles = files.filter(f => f.endsWith('.html')).length;
          const totalSize = require('child_process')
            .execSync(`du -sh ${buildDir}`)
            .toString()
            .split('\t')[0];
          
          const comment = `## ğŸ“š Documentation Preview
          
          âœ… **Build Status:** Successful
          ğŸ“Š **Build Stats:**
          - HTML Pages: ${htmlFiles}
          - Total Size: ${totalSize}
          - Node.js: ${{ env.NODE_VERSION }}
          
          ğŸ” **Changes in this PR:**
          - Documentation updates detected
          - Build completed successfully
          - Ready for review
          
          > ğŸ“ This preview build validates that the documentation builds correctly with your changes.`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  # ğŸ” Health Check (ë°°í¬ í›„)
  health-check:
    name: Post-Deployment Health Check
    runs-on: ubuntu-latest
    needs: [deploy-github-pages]
    if: success() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    timeout-minutes: 5

    steps:
    - name: ğŸ” Health check
      run: |
        echo "ğŸ” Performing health check..."
        
        # GitHub Pages URL ê°€ì ¸ì˜¤ê¸°
        SITE_URL="${{ needs.deploy-github-pages.outputs.page_url }}"
        
        if [[ -z "$SITE_URL" ]]; then
          echo "âš ï¸  Deployment URL not available, skipping health check"
          exit 0
        fi
        
        echo "ğŸŒ Checking: $SITE_URL"
        
        # HTTP ìƒíƒœ ì²´í¬ (ìµœëŒ€ 5ë²ˆ ì¬ì‹œë„)
        for i in {1..5}; do
          echo "ğŸ”„ Attempt $i/5..."
          
          response=$(curl -s -o /dev/null -w "%{http_code}" "$SITE_URL" || echo "000")
          
          if [[ "$response" == "200" ]]; then
            echo "âœ… Health check passed! Site is responding correctly."
            
            # ê°„ë‹¨í•œ ì½˜í…ì¸  ê²€ì¦
            if curl -s "$SITE_URL" | grep -q "SimpleEnvs"; then
              echo "âœ… Content validation passed!"
            else
              echo "âš ï¸  Content validation failed - SimpleEnvs not found in homepage"
            fi
            
            break
          else
            echo "âŒ Health check failed with response code: $response"
            if [[ $i -eq 5 ]]; then
              echo "âŒ Max retries reached. Site may not be ready yet."
              exit 1
            fi
            sleep 30
          fi
        done

    - name: ğŸ“ Update deployment status
      if: always()
      run: |
        echo "## ğŸ¥ Health Check Results" >> $GITHUB_STEP_SUMMARY
        echo "**Check Time:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**Site URL:** ${{ needs.deploy-github-pages.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ job.status == 'success' && 'âœ… Healthy' || 'âŒ Issues Detected' }}" >> $GITHUB_STEP_SUMMARY